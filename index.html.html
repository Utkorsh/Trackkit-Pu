<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackIt@PU | Campus Explorer & Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind CSS with PU's theme -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode class
            theme: {
                extend: {
                    colors: {
                        'pu-primary': '#023e8a', // Deep PU Blue
                        'pu-gold': '#ffc312',    // Primary Accent Gold
                        'pu-dark': '#0f0f0f',
                        'bg-main-dark': '#141414',
                        'card-dark': '#1e1e1e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'pop-in': 'popIn 0.5s ease-out forwards',
                        'slide-left': 'slideLeft 0.5s ease-out forwards',
                        // Speed set to 15s for smoother reading while fast
                        'marquee': 'marquee 15s linear infinite', 
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        slideLeft: {
                            '0%': { opacity: '0', transform: 'translateX(20px)' },
                            '100%': { transform: 'translateX(0px)' },
                        },
                        marquee: { // Marquee Keyframes (Smoother and Faster)
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Custom Styles for Extreme Dark Mode and Light Mode Overrides -->
    <style>
        /* Default body style (DARK MODE - Extreme Contrast) */
        body {
            background-color: #141414;
            color: #f3f4f6;
            transition: background-color 0.5s;
        }
        .card-base {
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }
        .dark .card-dark {
            background-color: #1e1e1e;
            border: 1px solid #2a2a2a;
        }
        .dark .card-dark:hover {
            background-color: #2a2a2a;
            box-shadow: 0 10px 25px rgba(255, 255, 255, 0.1);
        }

        /* --- LIGHT MODE OVERRIDES (VIBRANT PU THEME) --- */
        .light body {
            background-color: #ffffff;
            color: #141414;
        }
        .light .navbar a {
            color: #023e8a;
        }
        .light .card-base {
            background-color: #f9f9f9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
        }
        .light .text-white { color: #141414; }
        .light .text-gray-400 { color: #4b5563; }
        .light .bg-gray-700 { background-color: #e5e7eb; }
        .light .visited { background-color: #d1fae5; color: #065f46; }
        .light .card-item { @apply bg-white text-pu-primary border-pu-primary/20 hover:border-pu-gold hover:text-pu-gold; }
        .light #route-content { @apply bg-white border-pu-primary; }
        .light #modal-title { color: #023e8a; }
        .light #modal-type, .light #modal-route-details { color: #4b5563; }
        .light #route-content button { background-color: #023e8a; color: white; border-color: #023e8a; }

        /* Explore item styling: DEEPLY ROUNDED corners for premium feel (2.5rem = 40px) */
        .card-item {
            /* Default rounding for quick access, dashboard, and sublists */
            @apply bg-card-dark text-white p-5 rounded-[2.5rem] shadow-lg font-semibold cursor-pointer transition-all duration-300 border border-gray-700 hover:border-pu-gold hover:text-pu-gold;
            line-height: 1.4;
            min-height: 4rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.125rem;
        }
        /* Specific styling for the marquee item shapes (Pill Shape) */
        .marquee-content-item {
            @apply px-6 py-2.5 rounded-full border border-pu-gold/50 shadow-inner;
            background-color: rgba(2, 62, 138, 0.5); /* pu-primary with opacity */
            text-shadow: 1px 1px 2px #000;
            white-space: nowrap; /* Prevent wrapping inside item */
        }
        /* Style for the nested sub-list cards - slightly smaller curve */
        #sublist-content .card-item {
            @apply p-3 rounded-xl min-height: 0; 
        }
        /* Overriding hardcoded rounded-3xl to ensure consistent curviness */
        .card-base, #route-content, #confirmation-content, .rounded-3xl {
            border-radius: 2.5rem; /* Apply extreme curve to main containers */
        }


        /* Custom Modal Styling for Route */
        #route-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            pointer-events: none;
        }
        #route-modal.show-modal {
            opacity: 1;
            pointer-events: auto;
        }
        #route-content {
            /* Adjusted for better mobile fit */
            @apply bg-pu-dark p-6 sm:p-10 rounded-[2.5rem] shadow-2xl w-full max-w-lg border-4 border-pu-gold; 
            margin: 1rem; /* Added margin for small screens */
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #route-content img {
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
            width: 100%;
        }

        /* Page container hidden by default */
        .page-content {
            display: none;
        }

        /* Hero Section Custom Style */
        .hero-home {
            height: calc(100vh - 80px); /* Full screen minus nav height */
            background: linear-gradient(135deg, #141414 0%, #2a2a2a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        /* Mobile adjustment for title size */
        .hero-home h1 {
            font-size: 3.5rem; /* ~text-6xl for mobile */
        }
        @media (min-width: 768px) {
            .hero-home h1 {
                 font-size: 5.625rem; /* text-7xl */
            }
        }
        @media (min-width: 1024px) {
            .hero-home h1 {
                 font-size: 8rem; /* text-9xl */
            }
        }
        .light .hero-home {
             background: linear-gradient(135deg, #ffffff 0%, #e9e9e9 100%);
        }
        .explore-sublist-container {
            min-height: 40vh;
        }

        .animate-marquee > div {
            display: flex;
            gap: 3rem;
            padding-left: 100%; 
        }

        /* Custom styles for the confirmation modal */
        #confirmation-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none; /* Controlled by JS */
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }
        /* Custom Asymmetric Shape for Explore Categories */
        .explore-shape {
             border-radius: 1.5rem 4rem 1.5rem 4rem !important; /* Top-Left, Top-Right, Bottom-Right, Bottom-Left */
             min-height: 8rem;
             /* Ensure mobile padding is good */
             padding: 1.5rem;
        }
        /* Styling for the new login page */
        #login-page {
            height: 80vh; /* Take up most of the viewport height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .login-card {
            max-width: 450px;
            width: 90%;
            padding: 2.5rem;
        }

    </style>
</head>

<body class="font-sans min-h-screen">

    <!-- 1. Navigation Bar (High-Contrast, Minimalist) -->
    <nav class="navbar sticky top-0 z-50 bg-pu-dark/95 backdrop-blur-md shadow-2xl transition duration-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <div class="flex-shrink-0">
                <a href="#" onclick="showPage('home')" class="text-4xl font-extrabold text-white tracking-widest transition duration-300">
                    <span class="font-black text-pu-gold italic">TRACK</span><span class="font-light">IT</span><span class="text-pu-gold">@</span><span class="font-black">PU</span>
                </a>
            </div>
            <!-- Desktop Navigation -->
            <div class="md:flex space-x-8 hidden">
                <a href="#" onclick="showPage('home')" class="text-white hover:text-pu-gold font-semibold py-2 transition duration-300 transform hover:scale-105 uppercase">HOME</a>
                <a href="#" onclick="showPage('explore')" class="text-white hover:text-pu-gold font-semibold py-2 transition duration-300 transform hover:scale-105 uppercase">EXPLORE</a>
                <a href="#" onclick="showPage('dashboard')" class="text-white hover:text-pu-gold font-semibold py-2 transition duration-300 transform hover:scale-105 uppercase">DASHBOARD</a>
                <a href="#" onclick="showPage('settings')" class="text-white hover:text-pu-gold font-semibold py-2 transition duration-300 transform hover:scale-105 uppercase">SETTINGS</a>
            </div>
            <!-- Auth Buttons (Managed by JS) -->
             <div class="flex space-x-4">
                <button id="nav-login-btn" onclick="showPage('login')" class="hidden bg-pu-primary text-white py-2 px-4 rounded-xl font-bold text-sm hover:bg-pu-gold hover:text-pu-dark transition duration-300">
                    LOGIN
                </button>
                <button id="nav-logout-btn" onclick="mockLogout()" class="hidden bg-red-700 text-white py-2 px-4 rounded-xl font-bold text-sm hover:bg-red-800 transition duration-300">
                    LOGOUT
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- 0. LOGIN PAGE (New Section) -->
        <section id="login-page" class="page-content">
            <div class="login-card card-base card-dark rounded-[2.5rem] shadow-2xl animate-fade-in border-4 border-pu-gold">
                <h2 class="text-4xl font-extrabold text-pu-gold mb-4 uppercase tracking-wider">LOGIN TO TRACKIT@PU</h2>
                <p class="text-gray-400 mb-8">Use your student credentials to access the full explorer dashboard.</p>
                
                <p class="text-sm text-gray-500 italic mb-4">MOCK LOGIN: Use any Username/ID and Password: **puuser**</p>

                <div class="space-y-5 text-left">
                    <div>
                        <label for="login-username" class="block font-semibold mb-2 text-gray-300">STUDENT/EXPLORER ID:</label>
                        <input type="text" id="login-username" value="PU_Explorer_101" placeholder="Enter ID or Username" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                    </div>
                    <div>
                        <label for="login-password" class="block font-semibold mb-2 text-gray-300">PASSWORD:</label>
                        <input type="password" id="login-password" value="puuser" placeholder="Enter Password (puuser)" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                    </div>
                </div>

                <button onclick="mockLogin()" class="w-full mt-8 bg-pu-gold text-pu-dark py-3 px-10 rounded-full font-extrabold text-xl hover:bg-white transition duration-300 transform hover:scale-[1.02] shadow-xl uppercase border-2 border-pu-gold">
                    SECURE LOGIN
                </button>
                
                <p id="login-status" class="text-center mt-4 font-bold text-gray-400 min-h-[1rem]"></p>
            </div>
        </section>

        <!-- 2. HOME PAGE (Cinematic, Unique Design) -->
        <section id="home-page" class="page-content">
            <div class="hero-home">
                <!-- Font size adjusted in CSS for responsiveness -->
                <h1 class="font-black text-white leading-none tracking-tighter animate-pop-in uppercase">
                    CAMPUS <span class="text-pu-gold">NAVIGATION</span> SYSTEM.
                </h1>
                <p class="text-2xl sm:text-3xl text-gray-400 font-bold mt-8 sm:mt-10 tracking-wide">
                    DISCOVER NEW LOCATIONS. TRACK YOUR PROGRESS.
                </p>
                <button onclick="showPage('explore')" class="mt-12 bg-pu-gold text-pu-dark py-4 px-10 rounded-full font-extrabold text-xl hover:bg-white hover:text-pu-dark transition duration-300 transform hover:scale-105 shadow-2xl uppercase border-2 border-pu-gold">
                    START EXPLORING
                </button>
            </div>
              <!-- Dynamic Marquee Section (FIXED: Continuous Loop) -->
            <div class="mt-16 overflow-hidden border-t-2 border-b-2 border-pu-gold/50 py-4 bg-gray-900/50 max-w-4xl mx-auto">
                <div class="animate-marquee">
                    <div id="marquee-content" class="flex gap-16 text-lg text-white font-mono tracking-wider">
                        <!-- Marquee content dynamically inserted here -->
                    </div>
                </div>
            </div>
              <!-- Quick Access Panel (Curvy Shapes Applied, Mobile-Optimized Grid) -->
            <div class="mt-16 card-base card-dark p-8 rounded-[2.5rem] shadow-xl animate-fade-in border border-gray-800">
                <h3 class="text-3xl font-bold text-white mb-6 uppercase border-b border-gray-700 pb-2">QUICK EXPLORE ACCESS</h3>
                <!-- Grid changed to 2 columns on mobile (sm:grid-cols-3) to ensure touch target size -->
                <div id="quick-access-panel" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                    <!-- Dynamic Category Cards go here -->
                </div>
                <!-- Additional Quick Links Section (Mobile-Optimized Grid) -->
                <div class="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div onclick="showPage('explore'); loadSubList('Facilities & Outlets')" class="card-item bg-green-900/40 border-green-700/50 hover:bg-green-700/60 transition duration-300 hover:shadow-green-500/20 rounded-xl">
                        <span class="text-2xl mb-1">🍔</span> <span class="font-black text-white text-sm">Food & Cafes</span>
                    </div>
                    <div onclick="showPage('explore'); loadSubList('Admin & Support')" class="card-item bg-red-900/40 border-red-700/50 hover:bg-red-700/60 transition duration-300 hover:shadow-red-500/20 rounded-xl">
                        <span class="text-2xl mb-1">📜</span> <span class="font-black text-white text-sm">Student Support</span>
                    </div>
                    <div onclick="showPage('dashboard'); generateAITip()" class="card-item bg-yellow-900/40 border-yellow-700/50 hover:bg-yellow-700/60 transition duration-300 hover:shadow-yellow-500/20 rounded-xl">
                        <span class="text-2xl mb-1">💡</span> <span class="font-black text-white text-sm">AI Campus Tip</span>
                    </div>
                    <!-- New Option: PU Resources -->
                    <div onclick="showPage('settings')" class="card-item bg-indigo-900/40 border-indigo-700/50 hover:bg-indigo-700/60 transition duration-300 hover:shadow-indigo-500/20 rounded-xl">
                        <span class="text-2xl mb-1">🔗</span> <span class="font-black text-white text-sm">PU Resources</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. EXPLORE CAMPUS PAGE (Mobile-Optimized Grid) -->
        <section id="explore-page" class="page-content">
            <h2 class="text-4xl font-extrabold text-pu-gold mb-8 text-center border-b-4 border-white inline-block pb-1 uppercase tracking-wider">EXPLORE CAMPUS LOCATIONS</h2>
            <p class="text-center text-lg text-gray-400 mb-10" id="explore-subtitle">Select a category to view detailed locations and routes.</p>

            <div class="card-base card-dark p-6 sm:p-8 rounded-[2.5rem] shadow-xl animate-fade-in explore-sublist-container">

                <!-- Explore Stage 1: Categories (Asymmetric Shapes) -->
                <!-- Grid changed to 2 columns on mobile -->
                <div id="explore-categories" class="grid grid-cols-2 md:grid-cols-6 gap-4 sm:gap-6">
                    <!-- Academic Blocks (Span 2) - Custom Asymmetric Shape -->
                    <div onclick="loadSubList('Academic Blocks')" class="card-item explore-shape col-span-2 bg-pu-primary/20 hover:bg-pu-primary/40 border-pu-primary/50 text-pu-gold hover:shadow-pu-gold/20">
                        <span class="text-3xl mb-1">🎓</span> ACADEMIC BLOCKS
                    </div>
                    <!-- Facilities & Outlets (Span 2) - Custom Asymmetric Shape -->
                    <div onclick="loadSubList('Facilities & Outlets')" class="card-item explore-shape col-span-2 bg-green-500/20 hover:bg-green-500/40 border-green-500/50 text-white hover:shadow-green-500/20">
                        <span class="text-3xl mb-1">🍕</span> FACILITIES & OUTLETS
                    </div>
                    <!-- Admin & Support (Span 2) - Custom Asymmetric Shape -->
                    <div onclick="loadSubList('Admin & Support')" class="card-item explore-shape col-span-2 bg-red-800/20 hover:bg-red-800/40 border-red-800/50 text-white hover:shadow-red-800/20">
                        <span class="text-3xl mb-1">📝</span> ADMIN & SUPPORT
                    </div>
                    <!-- Student Life & Culture (Span 3) - Collapsed to 2 on Mobile -->
                    <div onclick="loadSubList('Student Life & Culture')" class="card-item explore-shape col-span-2 md:col-span-3 bg-pink-500/20 hover:bg-pink-500/40 border-pink-500/50 text-white hover:shadow-pink-500/20">
                        <span class="text-3xl mb-1">🥳</span> STUDENT LIFE & CULTURE
                    </div>
                    <!-- Research & Innovation (Span 3) - Collapsed to 2 on Mobile -->
                    <div onclick="loadSubList('Research & Innovation')" class="card-item explore-shape col-span-2 md:col-span-3 bg-yellow-500/20 hover:bg-yellow-500/40 border-yellow-500/50 text-white hover:shadow-yellow-500/20">
                        <span class="text-3xl mb-1">💡</span> R&D & INNOVATION
                    </div>
                </div>

                <!-- Explore Stage 2: Sub-List (Dynamically loaded) -->
                <div id="explore-sublist" class="hidden">
                    <button onclick="showPage('explore')" class="mb-6 text-pu-gold hover:text-white transition duration-300 transform hover:scale-105 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Categories
                    </button>
                    <h3 id="sublist-title" class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-3 uppercase"></h3>
                    <div id="sublist-content" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Dynamic items loaded here -->
                    </div>
                </div>

            </div>
        </section>

        <!-- 4. DASHBOARD PAGE (Curvy Shapes and New Options Included) -->
        <section id="dashboard-page" class="page-content">
            <h2 class="text-4xl font-extrabold text-pu-gold mb-8 text-center border-b-4 border-white inline-block pb-1 uppercase tracking-wider">EXPLORER DASHBOARD 📊</h2>
            <p class="text-center text-lg text-gray-400 mb-10">Track your progress to become a **PU Master Explorer**.</p>

            <!-- Progress Area (Style Changed - Dynamic Description) -->
            <div class="card-base card-dark p-8 rounded-[2.5rem] shadow-xl mb-10 animate-fade-in border border-gray-800">
                <h3 class="text-3xl font-bold text-white mb-6 uppercase">EXPLORATION STATUS:</h3>

                <div class="w-full bg-gray-600 rounded-full h-10 mb-4 overflow-hidden shadow-inner flex items-center justify-center relative">
                    <div id="overall-progress" class="h-full text-sm font-bold text-pu-dark text-center p-0.5 leading-none rounded-full transition-all duration-1500 ease-out absolute left-0 top-0" style="width: 0%; background: linear-gradient(90deg, #ffc312, #f59e0b);"></div>
                    <span id="progress-description" class="font-black z-10 text-shadow-lg text-sm md:text-base">Initiating Exploration...</span>
                </div>

                <p class="text-xl font-semibold text-white mt-4">
                    Total Explorer Points: <span id="current-points" class="text-pu-gold">0</span> / <span id="max-points">12</span>
                </p>
                
                <!-- NEW: Monthly Goal Setting -->
                <div class="mt-6 p-4 bg-gray-900 rounded-2xl border border-gray-700">
                    <label for="monthly-goal" class="block font-semibold mb-2 text-gray-300">MONTHLY GOAL (% CHECKPOINTS):</label>
                    <input type="number" id="monthly-goal" placeholder="e.g., 75" min="0" max="100" class="w-full p-2 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                </div>

                <!-- Daily Check-in Feature -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="dailyCheckIn()" id="check-in-btn" class="bg-green-600 text-white p-3 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase disabled:opacity-50">
                        ☀️ Daily Check-in
                    </button>
                    <!-- New: Trivia Challenge -->
                    <button onclick="showTrivia()" id="trivia-btn" class="bg-indigo-600 text-white p-3 rounded-xl font-bold text-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                        ❓ Campus Trivia
                    </button>
                </div>
                <p id="check-in-status" class="text-center text-sm mt-2 text-gray-400"></p>

            </div>

            <!-- Milestone Badges (Curvy Shapes Applied) -->
            <div class="card-base card-dark p-8 rounded-[2.5rem] shadow-xl mb-8 border border-gray-800 animate-fade-in" style="animation-delay: 0.1s;">
                <h3 class="text-3xl font-bold text-white mb-6 uppercase">EXPLORER MILESTONES 🏆</h3>
                <div id="milestone-badges" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Badges dynamically rendered here by JS -->
                </div>
            </div>

            <!-- AI Motivation Card (Curvy Shapes Applied) -->
            <div class="card-base card-dark p-8 rounded-[2.5rem] shadow-xl animate-fade-in" style="animation-delay: 0.3s;">
                <h3 class="text-3xl font-bold text-white mb-4 border-b border-gray-700 pb-2 flex items-center justify-center uppercase">
                    AI CAMPUS MENTOR ✨
                </h3>
                <div id="ai-tip-display" class="min-h-[6rem] text-center text-gray-300 italic flex items-center justify-center p-3 rounded-xl border border-dashed border-gray-600 mb-4">
                    Get a fresh tip and motivation based on your current progress!
                </div>
                <button onclick="generateAITip()" id="ai-tip-btn" class="w-full bg-pu-primary text-white p-3 rounded-xl font-bold text-lg hover:bg-pu-gold hover:text-pu-dark transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                    ✨ Generate Today's Tip
                </button>
                <div id="ai-loading" class="text-pu-gold mt-2 hidden text-center">AI is thinking...</div>
            </div>

            <!-- Tracking List (Curvy Shapes Applied) -->
            <div class="card-base card-dark p-8 rounded-[2.5rem] shadow-xl animate-fade-in mt-8" style="animation-delay: 0.2s;">
                <h3 class="text-3xl font-bold text-white mb-6 uppercase">CHECKPOINTS</h3>
                <ul id="place-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <!-- List items kept the same but styled by updateProgress -->
                    <li data-points="2" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Central Library (C2) - Reading Hall <span class="text-2xl check-icon">🔳</span></li>
                    <li data-points="1" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Main Food Court (G2) <span class="2xl check-icon">🔳</span></li>
                    <li data-points="2" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">FET Block (A1) - Top Floor <span class="2xl check-icon">🔳</span></li>
                    <li data-points="1" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Student Centre (G1) <span class="2xl check-icon">🔳</span></li>
                    <li data-points="2" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Gym & Sports Complex (G5) <span class="2xl check-icon">🔳</span></li>
                    <li data-points="1" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Placement Cell Office <span class="2xl check-icon">🔳</span></li>
                    <li data-points="2" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Central Auditorium (C1) <span class="2xl check-icon">🔳</span></li>
                    <li data-points="1" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">University Main Gate <span class="2xl check-icon">🔳</span></li>
                    <li data-points="2" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Hospital Block (E) Entrance <span class="2xl check-icon">🔳</span></li>
                    <li data-points="1" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Bank & ATM Facility (B1) <span class="2xl check-icon">🔳</span></li>
                    <li data-points="2" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Polytechnic Workshop (A7) <span class="2xl check-icon">🔳</span></li>
                    <li data-points="1" class="p-4 bg-gray-800 rounded-xl cursor-pointer transition duration-300 flex justify-between items-center text-lg font-medium text-gray-200 border border-gray-700 hover:border-pu-gold">Hostel Admin Block <span class="2xl check-icon">🔳</span></li>
                </ul>
            </div>
        </section>

        <!-- 5. SETTINGS PAGE (Improved Layout and More Options) -->
        <section id="settings-page" class="page-content">
            <h2 class="text-4xl font-extrabold text-pu-gold mb-8 text-center border-b-4 border-white inline-block pb-1 uppercase tracking-wider">SETTINGS 🛠️</h2>
            <p class="text-center text-lg text-gray-400 mb-10">Customize every detail of your TrackIt@PU experience and data.</p>

            <div class="max-w-5xl mx-auto space-y-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- Group 1: User Profile & Security (Col 1 - MORE OPTIONS, Curvy Shapes Applied) -->
                <div class="card-base card-dark p-8 rounded-[2.5rem] shadow-xl animate-fade-in border border-gray-800">
                    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2 uppercase text-pu-gold">ACCOUNT & PROFILE</h3>
                    
                    <div class="bg-gray-800 p-4 rounded-xl mb-4">
                         <p class="text-sm text-gray-400">Current User ID (Database):</p>
                         <p class="text-base text-white font-mono break-all" id="user-id-display">-- Not Logged In --</p>
                    </div>

                    <label for="username" class="block font-semibold mb-2 text-gray-300 mt-4">EXPLORER ALIAS:</label>
                    <input type="text" id="username" placeholder="E.g., PU-Master" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">

                    <!-- Button to reset alias to random ID -->
                    <button onclick="resetExplorerAlias()" class="w-full mt-2 bg-gray-600 text-white p-3 rounded-xl font-bold text-lg hover:bg-gray-700 transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                        RESET EXPLORER ALIAS
                    </button>
                    
                    <label for="password-change" class="block font-semibold mb-2 text-gray-300 mt-4">SECURITY: CHANGE PASSWORD/PIN:</label>
                    <button class="w-full bg-red-700 text-white p-3 rounded-xl font-bold text-lg hover:bg-red-800 transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                        INITIATE SECURE CHANGE
                    </button>
                    
                    <label for="tracking-pref" class="block font-semibold mb-2 text-gray-300 mt-4">LOCATION TRACKING PREFERENCE:</label>
                    <select id="tracking-pref" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                        <option>ACCURATE (High Power Use)</option>
                        <option>BALANCED (Default)</option>
                        <option>BATTERY SAVER (Less Accurate)</option>
                    </select>

                    <button onclick="saveSettings()" class="w-full mt-6 bg-green-700 text-white p-3 rounded-xl font-bold text-lg hover:bg-green-800 transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                        SAVE ACCOUNT SETTINGS
                    </button>
                </div>

                <!-- Group 2: Appearance & Functionality (Col 2 - MORE OPTIONS, Curvy Shapes Applied) -->
                <div class="card-base card-dark p-8 rounded-[2.5rem] shadow-xl animate-fade-in border border-gray-800" style="animation-delay: 0.1s;">
                    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2 uppercase text-pu-gold">VISUALS & FUNCTIONALITY</h3>
                    
                    <label for="theme-toggle" class="block font-semibold mb-2 text-gray-300 mt-4">SELECT THEME:</label>
                    <select id="theme-toggle" onchange="changeTheme(this.value)" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                        <option value="dark">🌑 DARK MODE (DEFAULT)</option>
                        <option value="light">✨ LIGHT MODE (VIBRANT PU)</option>
                    </select>
                    
                    <label for="language-pref" class="block font-semibold mb-2 text-gray-300 mt-4">PREFERRED LANGUAGE:</label>
                    <select id="language-pref" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                        <option>English (US)</option>
                        <option>Hindi (हिंदी)</option>
                        <option>Gujarati (ગુજરાતી)</option>
                    </select>
                    
                    <label for="default-page" class="block font-semibold mb-2 text-gray-300 mt-4">DEFAULT LANDING PAGE:</label>
                    <select id="default-page" onchange="saveDefaultPage(this.value)" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                        <option value="home">HOME (Hero View)</option>
                        <option value="explore">EXPLORE (Categories)</option>
                        <option value="dashboard">DASHBOARD (Progress)</option>
                    </select>

                    <label for="progress-label-style" class="block font-semibold mb-2 text-gray-300 mt-4">PROGRESS BAR TEXT STYLE:</label>
                    <select id="progress-label-style" class="w-full p-3 border border-gray-600 bg-gray-800 rounded-xl text-lg focus:ring-pu-gold focus:border-pu-gold transition duration-300 text-white">
                        <option>DYNAMIC STATUS (Beginner, Master, etc.)</option>
                        <option>SIMPLE PERCENTAGE</option>
                        <option>POINTS ONLY</option>
                    </select>
                    
                    <label for="animation-toggle" class="block font-semibold mb-2 text-gray-300 mt-4">ANIMATIONS:</label>
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="animation-toggle" checked class="h-5 w-5 rounded border-gray-300 text-pu-gold focus:ring-pu-gold bg-gray-800">
                        <label for="animation-toggle" class="text-gray-400">ENABLE UI TRANSITIONS</label>
                    </div>
                </div>

                <!-- Group 3: Data Management (Full Width, Curvy Shapes Applied) -->
                <div class="lg:col-span-2 card-base card-dark p-8 rounded-[2.5rem] shadow-xl animate-fade-in border border-gray-800" style="animation-delay: 0.2s;">
                    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2 uppercase text-pu-gold">DATA MANAGEMENT</h3>

                    <p class="text-gray-400 mb-4">Manage your local exploration data and checkpoints.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Export Data -->
                        <button onclick="exportData()" class="bg-pu-primary text-white p-3 rounded-xl font-bold text-lg hover:bg-pu-gold hover:text-pu-dark transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                            ⬇️ EXPORT EXPLORER DATA
                        </button>
                        <!-- Reset Data -->
                        <button id="reset-data-btn" class="bg-red-700 text-white p-3 rounded-xl font-bold text-lg hover:bg-red-800 transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                            WIPE ALL EXPLORER DATA
                        </button>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <!-- 7. Route Modal (Curvy Shapes Applied) -->
    <div id="route-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm items-center justify-center z-[1000]">
        <div id="route-content" class="bg-card-dark p-6 sm:p-10 rounded-[2.5rem] shadow-2xl w-full max-w-lg border-4 border-pu-gold transform scale-90 opacity-0 transition-all duration-500">
            <img id="modal-image" src="https://placehold.co/600x200/2a2a2a/ffc312?text=Location+Image" alt="Location Image" class="mb-6 rounded-xl">
            <h4 class="text-4xl font-extrabold text-pu-gold mb-4 border-b-2 border-gray-700 pb-2 uppercase" id="modal-title"></h4>
            <p class="text-lg text-gray-400 font-medium mb-4 uppercase" id="modal-type"></p>
            <div id="modal-route-details"></div>

            <!-- NEW GEMINI FEATURE: Location Fun Fact -->
            <div class="mt-6 p-4 bg-gray-900 rounded-2xl border border-pu-gold/50">
                <h5 class="text-xl font-bold text-pu-gold mb-3">Location Fun Fact</h5>
                <div id="location-fact-display" class="text-sm text-gray-300 italic min-h-[2rem]">
                    Click '✨ Generate Fun Fact' for a cool detail about this location!
                </div>
                <button onclick="triggerLocationFact(document.getElementById('modal-title').textContent)" id="fact-btn" class="w-full mt-4 bg-pu-gold text-pu-dark py-2 rounded-xl font-bold text-lg hover:bg-white transition duration-300 transform hover:scale-[1.01] shadow-lg uppercase">
                    ✨ Generate Fun Fact
                </button>
                <div id="fact-loading" class="text-gray-400 mt-2 hidden text-center text-sm">AI is searching campus records...</div>
            </div>
            
            <button onclick="closeRouteModal()" class="w-full mt-6 bg-pu-gold text-pu-dark py-3 rounded-xl font-bold text-lg hover:bg-white hover:text-pu-dark transition duration-300 transform hover:scale-[1.02] border-2 border-pu-gold uppercase">
                CLOSE GUIDE
            </button>
        </div>
    </div>

    <!-- 8. Custom Confirmation Modal (Curvy Shapes Applied) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm items-center justify-center z-[1002] hidden">
        <div id="confirmation-content" class="card-dark p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm border-2 border-red-600 transition-all duration-300 transform scale-90 opacity-0">
            <h4 id="confirm-title" class="text-2xl font-bold text-red-500 mb-4"></h4>
            <p id="confirm-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel" class="bg-gray-700 text-white py-2 px-4 rounded-xl hover:bg-gray-600 transition duration-300 font-medium">Cancel</button>
                <button id="confirm-ok" class="bg-red-700 text-white py-2 px-4 rounded-xl hover:bg-red-800 transition duration-300 font-medium">Confirm</button>
            </div>
        </div>
    </div>


    <!-- 6. JavaScript Logic (Navigation, Dynamic Content, Dashboard, and Modal) -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE/APP VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-trackit-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let app;
        let db;
        let auth;
        let userId = 'anon_user_default'; // Default ID before auth is ready

        // Check for required configuration
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Log for debugging
            // setLogLevel('Debug');
        } else {
            console.error("Firebase config not found. Running in localStorage mode.");
        }


        const pages = ['home', 'explore', 'dashboard', 'settings', 'login']; 
        let currentSublist = []; 
        
        let isLoggedIn = false;
        const MOCK_PASSWORD = "puuser"; 
        
        // --- DATA STATE (Replaced by Firestore Snapshot) ---
        // This is the single source of truth fetched from Firestore
        let userData = {
            visitedPlaces: {},
            lastCheckInDate: null,
            explorerAlias: 'PU_Explorer_Guest'
        };

        let modal; // Reference to the route modal element

        // --- FIREBASE DATA FUNCTIONS ---
        
        /** Returns the correct Firestore document path for the current user's private data. */
        function getUserDataRef(uid) {
            if (!db || !uid || uid === 'anon_user_default') {
                console.error("Database or User ID not available.");
                return null;
            }
            return doc(db, 'artifacts', appId, 'users', uid, 'data', 'explorer_data');
        }
        
        /** Loads user data from Firestore using a real-time listener. */
        function loadUserData(uid) {
            const docRef = getUserDataRef(uid);
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Update the global state with fetched data
                    const data = docSnap.data();
                    userData.visitedPlaces = data.visitedPlaces || {};
                    userData.lastCheckInDate = data.lastCheckInDate || null;
                    userData.explorerAlias = data.explorerAlias || userData.explorerAlias;
                    
                    console.log("Data loaded/updated from Firestore:", data);
                } else {
                    console.log("No data found for user. Initializing...");
                    // If document doesn't exist, set a default
                    saveUserData(); 
                }
                // Always update the UI after loading/initializing data
                updateUIFromUserData();
            }, (error) => {
                console.error("Error listening to user data:", error);
            });
        }
        
        /** Saves the current userData state back to Firestore. */
        async function saveUserData() {
            const docRef = getUserDataRef(userId);
            if (!docRef || !isLoggedIn) return; // Only save if logged in and ref is available

            const dataToSave = {
                visitedPlaces: userData.visitedPlaces,
                lastCheckInDate: userData.lastCheckInDate,
                explorerAlias: userData.explorerAlias,
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("User data successfully saved to Firestore.");
            } catch (error) {
                console.error("Error writing document:", error);
            }
        }
        
        /** Updates all UI elements based on the global userData state. */
        function updateUIFromUserData() {
            // Update Settings/Alias UI
            document.getElementById('user-id-display').textContent = userId;
            document.getElementById('username').value = userData.explorerAlias;
            
            // Re-run Dashboard Progress Logic
            updateProgress();
            checkDailyCheckInStatus(); 
        }

        // --- AUTHENTICATION FUNCTIONS (UPDATED FOR FIREBASE) ---
        
        async function initializeAuth() {
            if (!auth || !db) return;

            // 1. Set up Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    // Now that we have a UID, we load the actual data
                    loadUserData(userId); 
                } else {
                    console.log("No user signed in. Attempting Anonymous sign-in.");
                    userId = 'anon_user_default';
                    // Attempt anonymous sign-in if no user is found
                    signInAnonymously(auth).catch(e => console.error("Anonymous Sign-In failed:", e));
                }
            });
        }
        
        // Function to check auth state and navigate
        function checkAuth() {
            isLoggedIn = localStorage.getItem('isLoggedIn') === 'true'; 
            updateNavButtons();
            
            if (isLoggedIn) {
                const defaultPage = localStorage.getItem('pu-default-page') || 'home';
                // If logged in, navigate to default page (UI update handled by Firestore listener)
                showPage(defaultPage);
            } else {
                // If logged out, go to the login page
                showPage('login');
            }
        }

        // Function to update nav buttons visibility
        function updateNavButtons() {
            const navLinks = document.querySelectorAll('.md\\:flex a');
            const loginButton = document.getElementById('nav-login-btn');
            const logoutButton = document.getElementById('nav-logout-btn');
            
            if (isLoggedIn) {
                navLinks.forEach(link => link.classList.remove('hidden'));
                loginButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
            } else {
                navLinks.forEach(link => link.classList.add('hidden'));
                loginButton.classList.remove('hidden');
                logoutButton.classList.add('hidden');
            }
        }
        
        // Mock Login function
        async function mockLogin() {
            const userIdInput = document.getElementById('login-username').value.trim();
            const passwordInput = document.getElementById('login-password').value.trim();
            const statusDisplay = document.getElementById('login-status');
            
            if (!userIdInput || !passwordInput) {
                statusDisplay.textContent = "Please enter both Explorer ID and Password.";
                statusDisplay.classList.add('text-red-500');
                return;
            }
            
            if (passwordInput === MOCK_PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true');
                isLoggedIn = true;

                statusDisplay.textContent = "Login Successful! Redirecting...";
                statusDisplay.classList.remove('text-red-500');
                statusDisplay.classList.add('text-green-500');
                
                // IMPORTANT: Update the alias in the database after login
                userData.explorerAlias = userIdInput;
                await saveUserData(); 
                
                await showConfirmation("Welcome to TrackIt@PU!", `Hello, ${userIdInput}! You have successfully logged in to the Campus Explorer.`, "Start Tracking!", "", false);
                checkAuth(); // Update UI and redirect to default page
                
            } else {
                statusDisplay.textContent = "Invalid Password. (Hint: 'puuser')";
                statusDisplay.classList.add('text-red-500');
                statusDisplay.classList.remove('text-green-500');
                document.getElementById('login-password').value = ''; 
            }
        }

        // Mock Logout function
        async function mockLogout() {
            const confirmed = await showConfirmation(
                "Logout Confirmation",
                "Are you sure you want to log out of TrackIt@PU?",
                "Yes, Logout",
                "Cancel",
                true
            );
            
            if (confirmed) {
                localStorage.removeItem('isLoggedIn');
                isLoggedIn = false;
                // Since we use Anonymous Auth, the user remains signed into Firebase
                // But the UI shows they are 'logged out' of the mock app.
                
                showPage('login');
                updateNavButtons();
                await showConfirmation("Logged Out", "You have been logged out. See you soon!", "OK", "", false);
            }
        }

        // --- Custom Confirmation/Alert Logic (REPLACES alert() and confirm()) ---
        const confirmModalElement = document.getElementById('confirmation-modal');
        const confirmContentElement = document.getElementById('confirmation-content');

        /** Shows a custom confirmation dialog. */
        function showConfirmation(title, message, okText = 'Confirm', cancelText = 'Cancel', showCancel = true) {
            return new Promise(resolve => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-ok').textContent = okText;

                const cancelButton = document.getElementById('confirm-cancel');
                const okButton = document.getElementById('confirm-ok');
                
                if (showCancel) {
                    cancelButton.style.display = 'inline-block';
                    cancelButton.textContent = cancelText;
                    okButton.classList.remove('bg-pu-primary', 'hover:bg-pu-gold'); 
                    okButton.classList.add('bg-red-700', 'hover:bg-red-800'); 
                } else {
                    cancelButton.style.display = 'none';
                    okButton.classList.remove('bg-red-700', 'hover:bg-red-800');
                    okButton.classList.add('bg-pu-primary', 'hover:bg-pu-gold'); 
                }
                
                confirmModalElement.style.display = 'flex';
                setTimeout(() => {
                    confirmContentElement.classList.remove('scale-90', 'opacity-0');
                }, 10);

                const resolveAndClose = (result) => {
                    confirmContentElement.classList.add('scale-90', 'opacity-0');
                    setTimeout(() => confirmModalElement.style.display = 'none', 300);
                    resolve(result);
                    okButton.onclick = null;
                    cancelButton.onclick = null;
                };

                okButton.onclick = () => resolveAndClose(true);
                cancelButton.onclick = () => resolveAndClose(false);
            });
        }
        // --- END Custom Confirmation/Alert Logic ---


        // Function to handle Single Page Navigation
        function showPage(pageId) {
            if (pageId !== 'login' && !isLoggedIn) {
                if (document.getElementById('login-page').style.display !== 'block') {
                    showPage('login');
                }
                return;
            }
            
            pages.forEach(id => {
                const pageElement = document.getElementById(id + '-page');
                if (pageElement) {
                    pageElement.style.display = 'none';
                    pageElement.classList.remove('animate-fade-in');
                }
            });

            const activePage = document.getElementById(pageId + '-page');
            if (activePage) {
                activePage.style.display = 'block';
                setTimeout(() => {
                    activePage.classList.add('animate-fade-in');
                    if (pageId === 'explore') {
                        document.getElementById('explore-categories').classList.remove('hidden');
                        document.getElementById('explore-sublist').classList.add('hidden');
                        document.getElementById('explore-subtitle').textContent = 'Select a category to view detailed locations and routes.';
                    }
                }, 10);
            }
            updateNavButtons();
        }

        // Stage 2: Load the sublist (No changes needed)
        function loadSubList(category) {
            currentSublist = exploreData[category];
            const content = document.getElementById('sublist-content');
            const sublistElement = document.getElementById('explore-sublist');
            const categoriesElement = document.getElementById('explore-categories');

            categoriesElement.classList.add('hidden');
            sublistElement.classList.remove('hidden');
            sublistElement.classList.add('animate-slide-left');
            document.getElementById('sublist-title').textContent = category.toUpperCase();
            document.getElementById('explore-subtitle').textContent = `Now viewing: ${category}. Click a location for details.`;

            content.innerHTML = currentSublist.map(item => `
                <div onclick="showRouteDetail('${item.name}')" class="card-item bg-gray-700/50 hover:bg-gray-600/70 border-gray-600/70 text-white hover:scale-[1.03] transition duration-200 shadow-md rounded-xl">
                    ${item.name} <span class="text-sm font-light block mt-1 opacity-70">(${item.code})</span>
                </div>
            `).join('');
        }

        // Stage 3: Show the Route Modal (No changes needed)
        function showRouteDetail(placeName) {
            let data = null;
            for (const category in exploreData) {
                const found = exploreData[category].find(item => item.name === placeName);
                if (found) {
                    data = found;
                    break;
                }
            }

            if (!data) {
                 data = { name: placeName, code: 'N/A', type: 'Unknown', steps: ['Route information is not yet available for this location. Please check the central map.'], imageText: 'Location Not Found' };
            }

            document.getElementById('modal-title').textContent = data.name;
            document.getElementById('modal-type').textContent = `Code: ${data.code} | Category: ${data.type}`;

            const routeDetailsElement = document.getElementById('modal-route-details');
            const routeSteps = data.steps || ["No detailed route steps available. Refer to the location code and campus map."];

            routeDetailsElement.innerHTML = `
                <h5 class="text-2xl font-bold text-white mb-3">NAVIGATION STEPS:</h5>
                <ol class="list-decimal list-inside space-y-3 text-left ml-4 pt-2">
                    ${routeSteps.map(step => `<li class="font-medium text-lg text-gray-200">${step}</li>`).join('')}
                </ol>
            `;

            const placeholderUrl = `https://placehold.co/600x200/${data.type === 'Academic' ? '023e8a' : (data.type === 'Outlet' ? 'ffc312' : '4b5563')}/ffffff?text=${data.imageText.replace(/\s/g, '+')}`;
            document.getElementById('modal-image').src = placeholderUrl;
            document.getElementById('modal-image').alt = data.imageText;

            const factDisplay = document.getElementById('location-fact-display');
            if (factDisplay) {
                factDisplay.innerHTML = 'Click \'✨ Generate Fun Fact\' for a cool detail about this location!';
                document.getElementById('fact-btn').disabled = false;
                document.getElementById('fact-loading').classList.add('hidden');
            }

            let modalElement = document.getElementById('route-modal');
            if (modalElement) { 
                modalElement.style.display = 'flex';
                setTimeout(() => {
                    modalElement.classList.add('show-modal');
                    document.getElementById('route-content').classList.remove('opacity-0');
                    document.getElementById('route-content').style.transform = 'translateY(0px)';
                }, 10);
            }
        }

        function closeRouteModal() {
            let modalElement = document.getElementById('route-modal');
            if (modalElement) { 
                modalElement.classList.remove('show-modal');
                document.getElementById('route-content').classList.add('opacity-0');
                document.getElementById('route-content').style.transform = 'translateY(20px)'; 
                setTimeout(() => {
                    modalElement.style.display = 'none';
                }, 400);
            }
        }

        // --- EXPLORE DATA and MARQUEE DATA (static) ---
        const exploreData = {
            'Academic Blocks': [
                { name: 'FET (A1) Engineering & Tech', code: 'A1', type: 'Academic', imageText: 'Engineering Block A1', steps: [
                    "Begin your journey at the **Main Entry Gate** and proceed onto the main internal road.",
                    "Continue past the Guard Post and take the first wide right turn into the primary academic sector.",
                    "Block A1 (FET) is the **largest, multi-story building** you encounter on your left side, opposite the PICA (A2/A3) block.",
                    "The main administrative office for the faculty is located on the ground floor lobby."
                ]},
                { name: 'PICA & Applied Sciences (A2/A3)', code: 'A2, A3', type: 'Academic', imageText: 'PICA Block A2', steps: [
                    "Locate FET Block (A1) on the left side of the main academic corridor.",
                    "Blocks A2 and A3 are directly **opposite Block A1** on the right side of the corridor, connected to the Central Library (C2).",
                    "The main Computer Labs are generally located on the third and fourth floors of Block A2."
                ]},
                { name: 'Management Studies (FMS)', code: 'A14', type: 'Academic', imageText: 'FMS Block A14', steps: [
                    "From the main Academic Entrance, follow the path towards the **Central Auditorium (C1)**.",
                    "The FMS Block (A14) is prominently located **immediately behind the Central Auditorium** complex.",
                    "This area also includes dedicated executive classrooms and seminar halls."
                ]},
                { name: 'Architecture & Design (A17)', code: 'A17', type: 'Academic', imageText: 'Design Block A17', steps: [
                    "Head towards the far South-West academic wing, past the A10 (Law) block.",
                    "Block A17 (Architecture and Design) is located in this dedicated corner, recognizable by its unique facade."
                ]},
                { name: 'Polytechnic Institute', code: 'A7)', type: 'Academic', imageText: 'Polytechnic A7', steps: [
                    "Navigate through the academic complex towards the western, rear side of the blocks (closer to the Exit Gate).",
                    "The Polytechnic Institute (A7) is situated in this western wing, found **adjacent to the Applied Sciences (A8) block** and is recognizable by its workshop facilities on the ground floor."
                ]},
                { name: 'Pharmacy (PIP)', code: 'A6', type: 'Academic', imageText: 'Pharmacy A6', steps: [
                    "Locate the central cross-section path within the academic blocks (near the Nursing/Physiotherapy area).",
                    "Block A6 (Pharmacy) is clearly marked in the mid-western academic area and houses specialized pharmacology labs on the upper floors."
                ]},
                { name: 'Medical Sciences (PIMS/Hospital)', code: 'E2', type: 'Academic', imageText: 'PIMS Block E2', steps: [
                    "Head towards the Eastern boundary of the campus, close to the Hospital Complex (E).",
                    "PIMS Block (E2) is directly **attached to the main Hospital Complex**, look for the distinct red/white signage common to the medical facilities.",
                    "This section also houses the majority of the medical and allied health science departments."
                ]},
                { name: 'Law & Social Work (A10/A11)', code: 'A10, A11', type: 'Academic', imageText: 'Law and Social Work A10', steps: [
                    "From the Student Centre (G1), proceed towards the main academic blocks.",
                    "Blocks A10 (Law) and A11 (Social Work) are the last academic buildings on the main East side academic path, sharing common lecture halls.",
                    "The Law school often has its dedicated moot court facility on the first floor."
                ]},
                { name: 'Nursing & Physiotherapy', code: 'A4, A5', type: 'Academic', imageText: 'Nursing A4', steps: [
                    "Located centrally in the western academic zone, near the junction of A6 (Pharmacy).",
                    "Blocks A4 and A5 house specialized labs and classrooms for Nursing and Physiotherapy students. Look for simulation labs on the ground level."
                ]},
                { name: 'Aerospace Engineering', code: 'A12', type: 'Academic', imageText: 'Aerospace Engineering', steps: [
                    "Located in the dedicated South-West corner of the academic wing, near the Civil and Mechanical labs.",
                    "This block often features dedicated hangar space or large labs for simulation. The entrance is usually restricted to authorized personnel."
                ]},
                { name: 'Education & Commerce (A18)', code: 'A18', type: 'Academic', imageText: 'Education Commerce A18', steps: [
                    "Located on the far North-East edge of the academic cluster, near the main road.",
                    "This block handles departments like Education and Commerce, recognizable by the standardized classroom setups."
                ]},
            ],
            'Facilities & Outlets': [
                { name: 'Main Food Court & Canteen', code: 'G2', type: 'Outlet', imageText: 'Food Court G2', steps: [
                    "From the Main Gate, follow the road past the primary academic blocks.",
                    "Turn left into the **Central Campus Hub**. The Food Court complex (G2) is the large, dedicated structure you will see, adjacent to the Student Centre (G1).",
                    "The main seating area is usually on the ground floor, with specialized outlets on the periphery."
                ]},
                { name: 'Central Library & Reading Hall', code: 'C2', type: 'Facility', imageText: 'Central Library C2', steps: [
                    "Enter the main academic corridor where FET (A1) and PICA (A2/A3) are located.",
                    "The Central Library (C2) is a **large, prominent, stand-alone building** situated centrally, directly adjacent to the Central Auditorium (C1).",
                    "E-resource centers and research sections are usually located on the top floor. Silence is mandatory here."
                ]},
                { name: 'University Gym & Sports Complex', code: 'G5', type: 'Facility', imageText: 'University Gym G5', steps: [
                    "Head towards the **South-East** zone of the campus, navigating past the Hostel Blocks (H blocks).",
                    "The dedicated Sports Ground and Gym Complex (G5) is located in this specialized zone, look for the indoor sports arena building next to the fields."
                ]},
                { name: 'Central Auditorium & Convention Hall', code: 'C1', type: 'Facility', imageText: 'Auditorium C1', steps: [
                    "Walk towards the Central Library (C2).",
                    "The Central Auditorium (C1) is the main event facility, found **immediately attached to the Library complex** in the core academic area. Enter through the main double doors."
                ]},
                { name: 'Bank & ATM Facility', code: 'B1', type: 'Facility', imageText: 'Bank ATM B1', steps: [
                    "Proceed directly to the **Central Campus Hub** where the Food Court (G2) and Student Centre (G1) are situated.",
                    "The Bank/ATM facility (B1) is located within the **Student Centre or Food Court structure** complex, look for the standard banking signage."
                ]},
                { name: 'Nescafe Kiosk (FET Side)', code: 'A1-Ground', type: 'Outlet', imageText: 'Nescafe Kiosk', steps: [
                    "Enter the ground floor of the FET Block (A1) from the main academic corridor.",
                    "The Nescafe Kiosk is usually situated near the main entrance lobby or the student waiting area."
                ]},
                { name: 'Juice and Sandwich Bar (G2)', code: 'G2', type: 'Outlet', imageText: 'Juice Bar G2', steps: [
                    "Located inside the Main Food Court Complex (G2).",
                    "Find the dedicated section within the food court marked for fresh juice and light snacks. This is a popular spot during lunch hours."
                ]},
                { name: 'PU Transit Bus Stop (Inbound)', code: 'TS', type: 'Facility', imageText: 'Bus Stop TS', steps: [
                    "Located near the **Main Entry Gate** and the Hospital Complex (E).",
                    "This is the designated drop-off/pick-up point for the university shuttle services. Wait times vary based on schedule."
                ]},
                { name: 'Stationery & Book Store (G1)', code: 'G1', type: 'Outlet', imageText: 'Stationery Shop G1', steps: [
                    "Locate the **Student Centre (G1)** in the Central Campus Hub.",
                    "The Stationery and Photocopy shop is typically located on the ground floor of the G1 building, near the service desks."
                ]},
                { name: 'Medical/First Aid Post (E)', code: 'E', type: 'Facility', imageText: 'First Aid Post', steps: [
                    "Located at the main entrance of the Hospital Complex (E).",
                    "Use this post for immediate medical assistance or minor injuries before proceeding to the full Hospital facility."
                ]},
            ],
            'Admin & Support': [
                { name: 'Student Centre/Help Desk', code: 'G1', type: 'Support', imageText: 'Student Centre G1', steps: [
                    "The Student Centre (G1) is a **key landmark** located in the Central Campus Hub.",
                    "It handles enrollment, identity cards, and general student queries. Enter and proceed to the main reception desk."
                ]},
                { name: 'Central Administration Block (Registrar)', code: 'C', type: 'Admin', imageText: 'Admin Block C', steps: [
                    "Located centrally within the main academic quadrant, next to the Library (C2).",
                    "This block is the **primary administrative building (C)**, housing the Registrar's office and management suites. Inquire at the ground floor reception."
                ]},
                { name: 'Placement Cell Office', code: 'G1', type: 'Support', imageText: 'Placement Office', steps: [
                    "First, find the **Student Centre (G1)** in the Central Campus Hub.",
                    "The Placement Cell Office is generally located on the **first or second floor** of the Student Centre building. Inquire at the main reception desk for interview scheduling."
                ]},
                { name: 'Examination Section', code: 'C3', type: 'Admin', imageText: 'Examination Section', steps: [
                    "Find the Central Administration Block (C).",
                    "The Examination Section (C3) is a dedicated wing within the Administrative complex, responsible for all exam-related inquiries and documentation. Expect queues during peak times."
                ]},
                { name: 'HR and Finance Department', code: 'C5', type: 'Admin', imageText: 'HR and Finance Office', steps: [
                    "Located within the Central Administration Block (C) or a nearby annex (C5).",
                    "This office handles staff/faculty HR matters and all central financial queries. Inquire at the main Admin reception first."
                ]},
                { name: 'Scholarship Section (C3)', code: 'C3', type: 'Support', imageText: 'Scholarship Section', steps: [
                    "Navigate to the main Administrative Block area.",
                    "The Scholarship Section (C3) is located near the Examination Section, usually on the ground or first floor of the Admin Block complex. Bring all required documentation."
                ]},
                { name: 'Faculty Development Cell', code: 'C4', type: 'Admin', imageText: 'Faculty Development Cell', steps: [
                    "Located on the same floor as the Dean/Director Offices (C4).",
                    "This dedicated cell manages faculty training and research incentives. Access usually requires an appointment."
                ]},
                { name: 'International Relations Office', code: 'C', type: 'Admin', imageText: 'International Relations Office', steps: [
                    "Located in the Central Administration Block (C).",
                    "This office manages study abroad programs, student exchanges, and international collaborations."
                ]},
            ],
              'Student Life & Culture': [
                { name: 'Central Amphitheater (G1)', code: 'G1', type: 'Culture', imageText: 'Amphitheater G1', steps: [
                    "Locate the Student Centre (G1) in the Central Campus Hub.",
                    "The Amphitheater is an **outdoor seating area** usually situated directly outside the Student Centre, used for small events and gatherings."
                ]},
                { name: 'Cultural Activity Room (C1)', code: 'C1', type: 'Culture', imageText: 'Cultural Activity Room C1', steps: [
                    "Located on the ground floor of the Central Auditorium Complex (C1).",
                    "This room is booked for rehearsals, club meetings, and indoor cultural activities. Check the booking schedule first."
                ]},
                { name: 'NSS/NCC Office', code: 'A1-Ground', type: 'Culture', imageText: 'NSS NCC Office', steps: [
                    "Located on the ground floor of the main FET Block (A1).",
                    "This small office manages National Service Scheme (NSS) and National Cadet Corps (NCC) activities. Inquire about current projects."
                ]},
                { name: 'Innovation Hub', code: 'C', type: 'Culture', imageText: 'Innovation Hub C', steps: [
                    "Situated within the Central Administration Block (C) or a nearby annex.",
                    "This is a shared space designed for project development, hackathons, and idea brainstorming sessions. Access requires registration."
                ]},
                { name: 'Gaming Lounge (G2)', code: 'G2-Basement', type: 'Culture', imageText: 'Gaming Lounge G2', steps: [
                    "Located in the basement or dedicated annex of the Main Food Court (G2).",
                    "This area hosts casual indoor games, recreational activities, and some e-sports facilities. Student ID mandatory."
                ]},
                { name: 'Music and Arts Studio', code: 'A17', type: 'Culture', imageText: 'Music Arts Studio A17', steps: [
                    "Found adjacent to the Faculty of Design (A17) block.",
                    "These studios offer dedicated space for music practice, visual arts, and performance preparation."
                ]},
                { name: 'Hostel Recreation Room', code: 'H18', type: 'Culture', imageText: 'Hostel Recreation Room', steps: [
                    "Located in the basement or ground floor of the primary North Hostel Block (H18).",
                    "This room provides indoor games (like carrom, chess) and common TV facilities for residents."
                ]},
                { name: 'Equestrian Club Area', code: 'G7', type: 'Culture', imageText: 'Equestrian Area G7', steps: [
                    "Located on the far Eastern side of the campus, near the G7/G6 hostel blocks.",
                    "This specialized area is used for horse riding lessons and training sessions. Check club timing before visiting."
                ]},
            ],
              'Research & Innovation': [
                { name: 'Central Research Center (CRC)', code: 'C4', type: 'R&D', imageText: 'Central Research Center C4', steps: [
                    "Located on the designated upper floors of the Central Administration Block (C).",
                    "This center manages research grants, publications, and PhD registrations."
                ]},
                { name: 'Advanced Materials Lab (A8)', code: 'A8', type: 'R&D', imageText: 'Advanced Materials Lab A8', steps: [
                    "Located within the Applied Sciences block (A8), on the first floor.",
                    "This specialized lab is used for high-level materials testing and analysis, requiring specific faculty access."
                ]},
                { name: 'AI & Data Science COE', code: 'A2', type: 'R&D', imageText: 'AI COE A2', steps: [
                    "Located in a dedicated wing of the PICA/Computer Applications block (A2).",
                    "This Centre of Excellence (COE) focuses on AI projects and industry collaboration."
                ]},
                { name: 'Robotics and Automation Lab', code: 'A1', type: 'R&D', imageText: 'Robotics Lab A1', steps: [
                    "Found on the ground floor or a designated wing of the FET Block (A1).",
                    "This workshop area contains heavy machinery and equipment for robotics practicals. Safety gear is mandatory."
                ]},
                { name: 'IPR Cell (Intellectual Property)', code: 'C', type: 'R&D', imageText: 'IPR Cell C', steps: [
                    "Located within the main Administrative Block (C).",
                    "The IPR Cell assists faculty and students with patent and copyright filing procedures."
                ]},
                { name: 'Incubation Center (C)', code: 'C', type: 'R&D', imageText: 'Incubation Center', steps: [
                    "Located within the Central Administration Block (C).",
                    "This facility provides mentorship, seed funding support, and office space for student startups."
                ]},
            ]
        };
        const marqueeData = [
            "⚠️ PU EXPLORER PROGRESS IS LIVE: TRACK YOUR POINTS NOW.",
            "📚 STUDENT CENTRE (G1) OPEN FOR ID CARD RENEWALS.",
            "💻 NEW AI & DATA SCIENCE COE NOW ACTIVE IN BLOCK A2.",
            "⚽ SPORTS COMPLEX (G5) ANNUAL TOURNAMENT REGISTRATION OPEN.",
            "📖 CENTRAL LIBRARY OPEN 24/7 DURING EXAM WEEK.",
            "☕ FIND THE NEAREST NESCAFE KIOSK FOR YOUR NEXT BREAK."
        ];
        // --- END STATIC DATA ---

        const placeList = document.getElementById('place-list');
        const overallProgress = document.getElementById('overall-progress');
        const progressDescription = document.getElementById('progress-description');
        const currentPointsDisplay = document.getElementById('current-points');
        const quickAccessPanel = document.getElementById('quick-access-panel');
        const maxPointsDisplay = document.getElementById('max-points');

        const allListItems = placeList ? placeList.querySelectorAll('li') : [];
        let totalPoints = 0;
        allListItems.forEach(item => {
            totalPoints += parseInt(item.getAttribute('data-points'));
        });
        if (maxPointsDisplay) maxPointsDisplay.textContent = totalPoints;

        // --- DASHBOARD FUNCTIONS (UPDATED FOR FIREBASE) ---
        
        // Function to update progress UI based on userData state
        function updateProgress() {
            let currentPoints = 0;
            const places = userData.visitedPlaces || {};

            allListItems.forEach(item => {
                const textParts = item.textContent.match(/^(.*?)\s*(\s*🔳|\s*✅)$/);
                const placeText = textParts ? textParts[1].trim() : item.textContent.trim();

                if (places[placeText]) {
                    item.classList.add('visited');
                    item.querySelector('.check-icon').textContent = '✅';
                    currentPoints += parseInt(item.getAttribute('data-points'));
                } else {
                    item.classList.remove('visited');
                    item.querySelector('.check-icon').textContent = '🔳';
                }
            });

            // Daily Check-in Logic
            const today = new Date().toDateString();
            const checkedInPoint = (userData.lastCheckInDate === today) ? 1 : 0;
            currentPoints += checkedInPoint;
            
            const effectiveTotalPoints = totalPoints + 1; 
            const percentage = effectiveTotalPoints > 0 ? Math.round((currentPoints / effectiveTotalPoints) * 100) : 0;
            
            overallProgress.style.width = Math.min(percentage, 100) + '%';
            currentPointsDisplay.textContent = currentPoints;

            if (percentage >= 85) {
                overallProgress.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (percentage >= 40) {
                overallProgress.style.background = 'linear-gradient(90deg, #ffc312, #f59e0b)';
            } else {
                 overallProgress.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }

            updateProgressDescription(percentage);
            renderMilestones(percentage);
            // Removed localStorage.setItem('puVisited')
        }

        if (placeList) {
             placeList.addEventListener('click', async (e) => {
                 let listItem = e.target.closest('li');
                 if (listItem && isLoggedIn) {
                     const textParts = listItem.textContent.match(/^(.*?)\s*(\s*🔳|\s*✅)$/);
                     const nameToSave = textParts ? textParts[1].trim() : listItem.textContent.trim();

                     // Toggle state locally first, then save
                     userData.visitedPlaces[nameToSave] = !userData.visitedPlaces[nameToSave];
                     
                     // Use Firestore for persistence
                     await saveUserData();
                     // UI update happens automatically via onSnapshot
                 }
             });
        }

        // Daily Check-in Logic
        function checkDailyCheckInStatus() {
            const today = new Date().toDateString();
            const checkInBtn = document.getElementById('check-in-btn');
            const statusDisplay = document.getElementById('check-in-status');

            if (userData.lastCheckInDate === today) {
                checkInBtn.disabled = true;
                statusDisplay.textContent = '✅ You have successfully checked in today! (+1 Point)';
            } else {
                checkInBtn.disabled = false;
                statusDisplay.textContent = 'Earn 1 bonus point by checking in now.';
            }
        }

        async function dailyCheckIn() {
             const today = new Date().toDateString();
             if (userData.lastCheckInDate !== today && isLoggedIn) {
                 // Update state locally
                 userData.lastCheckInDate = today;
                 
                 // Save to Firestore
                 await saveUserData(); 
                 
                 await showConfirmation(
                    "Check-in Successful!",
                    "You earned 1 bonus Explorer Point for today's check-in! Keep up the great work!",
                    "Awesome!",
                    "",
                    false 
                );
             }
        }
        
        // --- SETTINGS FUNCTIONS (UPDATED FOR FIREBASE) ---
        async function resetExplorerAlias() {
            const confirmed = await showConfirmation(
                "Reset Alias",
                "Do you want to reset your Explorer Alias to a new random ID? This cannot be undone.",
                "Yes, Reset",
                "Cancel"
            );
            
            if (confirmed && isLoggedIn) {
                const newAlias = 'ANON-' + Math.random().toString(36).substring(2, 10).toUpperCase();
                // Update state locally and save
                userData.explorerAlias = newAlias;
                await saveUserData(); 

                await showConfirmation("Alias Updated", "Explorer Alias successfully reset!", "OK", "", false);
            }
        }
        
        async function saveSettings() {
             // Only saving alias to Firestore. Other settings (theme, page) remain in localStorage for simplicity/speed
             // But we are saving all data via saveUserData for consistency now.
             await saveUserData();
             await showConfirmation("Settings Saved", "Your Explorer Alias has been saved to the database.", "OK", "", false);
        }
        
        // Mock Export Function
        async function exportData() {
            const data = {
                // Get real data from global state
                visitedPlaces: userData.visitedPlaces,
                lastCheckIn: userData.lastCheckInDate,
                explorerAlias: userData.explorerAlias,
                
                // Other settings from local storage
                theme: localStorage.getItem('pu-theme'),
                defaultPage: localStorage.getItem('pu-default-page') || 'home',
                exportTime: new Date().toISOString()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            
            try {
                // Clipboard copy logic (unchanged)
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = jsonString;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                
                await showConfirmation(
                    "Data Exported!",
                    "Your progress data (JSON) has been successfully copied to your clipboard. Paste it into a file for backup.",
                    "Got It!",
                    "",
                    false
                );
            } catch (err) {
                 await showConfirmation(
                    "Export Error",
                    "Failed to copy data to clipboard. Check console.",
                    "OK",
                    "",
                    false
                );
                console.error("Export Data:", jsonString);
            }
        }
        
        // Reset/Wipe all data from Firestore
        async function wipeAllExplorerData() {
             const confirmed = await showConfirmation(
                "DANGER ZONE: WIPE DATA",
                "FINAL WARNING: Are you sure you want to delete all your exploration progress? This action cannot be undone.",
                "Yes, Wipe Data",
                "No, Keep Data"
            );

            if (confirmed && isLoggedIn) {
                const docRef = getUserDataRef(userId);
                if (docRef) {
                    try {
                        await deleteDoc(docRef);
                        // Reset local state to default values
                        userData.visitedPlaces = {};
                        userData.lastCheckInDate = null;
                        
                        await saveUserData(); // Creates a new default document
                        
                        await showConfirmation(
                            "Success!",
                            "Data wipe successful! Your exploration history has been reset.",
                            "OK",
                            "",
                            false 
                        );
                    } catch (error) {
                         await showConfirmation("Error", "Could not delete data. Check console.", "OK", "", false);
                         console.error("Error wiping data:", error);
                    }
                }
            }
        }

        const resetBtn = document.getElementById('reset-data-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', wipeAllExplorerData);
        }
        // --- END SETTINGS FUNCTIONS ---
        
        // --- REMAINING HELPER FUNCTIONS (unchanged) ---
        function updateProgressDescription(percentage) {
            if (percentage === 0) {
                progressDescription.textContent = "Initiating Exploration... 0% COMPLETE";
                progressDescription.classList.remove('text-pu-dark');
                progressDescription.classList.add('text-white');
            } else if (percentage <= 25) {
                progressDescription.textContent = "Beginner Explorer: Discover key academic blocks.";
                progressDescription.classList.remove('text-pu-dark');
                progressDescription.classList.add('text-white');
            } else if (percentage <= 50) {
                progressDescription.textContent = `Campus Walker: Halfway to an expert! ${percentage}% Progress`;
                progressDescription.classList.add('text-pu-dark');
                progressDescription.classList.remove('text-white');
            } else if (percentage < 100) {
                progressDescription.textContent = `Master Path: Just a few checkpoints left! ${percentage}% Progress`;
                progressDescription.classList.add('text-pu-dark');
                progressDescription.classList.remove('text-white');
            } else {
                progressDescription.textContent = "PU LEGEND: All core locations mapped! 100% ACHIEVED";
                progressDescription.classList.add('text-pu-dark');
                progressDescription.classList.remove('text-white');
            }
        }
        function renderMilestones(percentage) {
            const milestones = [
                { threshold: 1, name: 'NEWCOMER', achieved: false, icon: '🌟' },
                { threshold: 30, name: 'CAMPUS WALKER', achieved: false, icon: '🚶' },
                { threshold: 70, name: 'MASTER EXPLORER', achieved: false, icon: '🗺️' },
                { threshold: 100, name: 'PU LEGEND', achieved: false, icon: '👑' }
            ];

            let html = '';
            milestones.forEach(m => {
                m.achieved = percentage >= m.threshold;
                // Using rounded-3xl for milestones as well
                const badgeClass = m.achieved ? 'bg-pu-gold text-pu-dark animate-pop-in' : 'bg-gray-700 text-gray-400';
                html += `
                    <div class="${badgeClass} p-3 rounded-[2.5rem] text-center font-bold text-sm transition duration-300 shadow-lg">
                        ${m.icon} ${m.name}
                        <p class="text-xs font-normal mt-1 opacity-75">${m.threshold}% Achieved</p>
                    </div>
                `;
            });
            document.getElementById('milestone-badges').innerHTML = html;
        }
        function renderHomeContent() {
            if (!quickAccessPanel) return;

            const categories = Object.keys(exploreData);
            let html = categories.map((category, index) => {
                const itemCount = exploreData[category].length;
                const colorMap = {
                    'Academic Blocks': 'bg-pu-primary/20 hover:bg-pu-primary/40 border-pu-primary/50 text-pu-gold hover:shadow-pu-primary/30',
                    'Facilities & Outlets': 'bg-green-500/20 hover:bg-green-500/40 border-green-500/50 text-white hover:shadow-green-500/30',
                    'Admin & Support': 'bg-red-800/20 hover:bg-red-800/40 border-red-800/50 text-white hover:shadow-red-800/30',
                    'Student Life & Culture': 'bg-pink-500/20 hover:bg-pink-500/40 border-pink-500/50 text-white hover:shadow-pink-500/30',
                    'Research & Innovation': 'bg-yellow-500/20 hover:bg-yellow-500/40 border-yellow-500/50 text-white hover:shadow-yellow-500/30'
                };
                
                // Mobile-Optimized Column Spanning: defaults to 3/4 or 6/6 on small screens
                let colSpanClass = 'col-span-3 sm:col-span-3'; 
                if (index === 0) colSpanClass = 'col-span-6 md:col-span-4'; 
                else if (index === 1) colSpanClass = 'col-span-6 md:col-span-2'; 
                else if (index === 2) colSpanClass = 'col-span-3 md:col-span-2'; 
                else if (index === 3) colSpanClass = 'col-span-3 md:col-span-4'; 
                else if (index === 4) colSpanClass = 'col-span-6'; 

                const iconMap = {
                    'Academic Blocks': '🎓',
                    'Facilities & Outlets': '🍕',
                    'Admin & Support': '📝',
                    'Student Life & Culture': '🥳',
                    'Research & Innovation': '💡'
                };
                
                return `
                    <div onclick="showPage('explore'); loadSubList('${category}')" class="card-item ${colSpanClass} ${colorMap[category] || ''} hover:scale-[1.02] transition duration-200 shadow-xl rounded-[2.5rem]">
                        <span class="text-3xl font-black">${iconMap[category]}</span>
                        <span class="text-lg font-black mt-2">${category.toUpperCase()}</span>
                        <span class="text-xs block mt-1 opacity-70">${itemCount} Locations</span>
                    </div>
                `;
            }).join('');

            quickAccessPanel.innerHTML = html;
        }
        function renderMarquee() {
            const marqueeElement = document.getElementById('marquee-content');
            if (marqueeElement) {
                // FIX: Duplicate 20 times to guarantee seamless scrolling on all screens
                const singleHtml = marqueeData.map(item => `<span class="marquee-content-item">${item}</span>`).join('');
                marqueeElement.innerHTML = singleHtml.repeat(20); 
            }
        }
        async function generateAITip() {
            const btn = document.getElementById('ai-tip-btn');
            const loading = document.getElementById('ai-loading');
            const display = document.getElementById('ai-tip-display');
            const currentPoints = parseInt(document.getElementById('current-points').textContent) || 0;
            const totalPoints = 12;
            const percentage = totalPoints > 0 ? Math.round((currentPoints / totalPoints) * 100) : 0;

            btn.disabled = true;
            loading.classList.remove('hidden');
            display.innerHTML = 'AI is thinking...';

            const systemPrompt = "You are a friendly and professional AI Campus Mentor for Parul University. Your response must be in concise, encouraging English (max 2-3 sentences). Motivate the user based on their progress or provide a relevant campus/study tip. Always mention 'TrackIt@PU' in your response.";
            let userQuery;

            if (percentage < 30) {
                userQuery = `User's exploration progress is only ${percentage}%. Motivate them to start exploring key blocks like A1 and the Library (C2).`;
            } else if (percentage < 70) {
                userQuery = `User's progress is ${percentage}%. Congratulate them and encourage them to balance academics and campus facilities. Provide a quick study tip.`;
            } else {
                userQuery = `User's progress is ${percentage}%. Hail them as a Master Explorer and give final tips to complete the campus exploration and focus on academic excellence.`;
            }

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let resultText = "Could not connect to the AI Mentor service. Please check your network connection.";
            let retries = 0;
            const maxRetries = 5;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        resultText = candidate.content.parts[0].text;
                        break; // Success
                    }
                } catch (error) {
                    retries++;
                    if (retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            display.innerHTML = resultText;
            btn.disabled = false;
            loading.classList.add('hidden');
        }
        async function triggerLocationFact(placeName) {
            const btn = document.getElementById('fact-btn');
            const loading = document.getElementById('fact-loading');
            const display = document.getElementById('location-fact-display');

            btn.disabled = true;
            loading.classList.remove('hidden');
            display.innerHTML = '<span class="text-white">AI is searching campus records...</span>';

            const systemPrompt = "You are a witty and knowledgeable campus guide. Provide one engaging, concise fun fact or historical nugget (max 2 sentences, Hindi/English mix is fine) about this specific location at Parul University. If no real fact is available, provide a general motivation quote related to the location's purpose.";
            // Using Hindi/English mix in query
            const userQuery = `Parul University mein "${placeName}" ke baare mein ek fun fact/interesting detail batao.`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Google Search Grounding enabled here
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let resultText = "Search failed. Could not retrieve fact.";
            let retries = 0;
            const maxRetries = 3;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        resultText = candidate.content.parts[0].text;
                        break;
                    }
                } catch (error) {
                    retries++;
                    if (retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            display.innerHTML = resultText;
            btn.disabled = false;
            loading.classList.add('hidden');
        }
        async function showTrivia() {
            const triviaIndex = Math.floor(Math.random() * campusTrivia.length);
            const question = campusTrivia[triviaIndex];

            // Show alert modal for trivia (single button)
            await showConfirmation(
                "Campus Trivia Challenge!",
                question,
                "Got It!",
                "",
                false 
            );
        }
        const campusTrivia = [
            "The largest academic block on campus is the FET (A1) block.",
            "The Central Library (C2) houses over 200,000 physical volumes.",
            "The PU Transit Bus Stop is located near the Hospital Complex (E).",
            "The Placement Cell Office is typically found in the Student Centre (G1) building.",
            "The PU main campus covers over 150 acres of land.",
            "Block A17 is primarily dedicated to the Faculty of Architecture and Design.",
        ];
        function changeTheme(theme) {
            const htmlElement = document.documentElement;

            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                htmlElement.classList.remove('light');
            } else {
                htmlElement.classList.add('light');
                htmlElement.classList.remove('dark');
            }
            localStorage.setItem('pu-theme', theme);
        }
        function saveDefaultPage(pageId) {
            localStorage.setItem('pu-default-page', pageId);
            showConfirmation("Setting Saved", `Default page set to ${pageId.toUpperCase()}.`, "OK", "", false);
        }
        
        // --- Expose functions to global window object ---
        window.showPage = showPage;
        window.mockLogin = mockLogin;
        window.mockLogout = mockLogout;
        window.loadSubList = loadSubList;
        window.showRouteDetail = showRouteDetail;
        window.closeRouteModal = closeRouteModal;
        window.dailyCheckIn = dailyCheckIn;
        window.showTrivia = showTrivia;
        window.generateAITip = generateAITip;
        window.triggerLocationFact = triggerLocationFact;
        window.resetExplorerAlias = resetExplorerAlias;
        window.saveSettings = saveSettings;
        window.exportData = exportData;
        window.changeTheme = changeTheme;
        window.saveDefaultPage = saveDefaultPage;


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Modals
            let modalElement = document.getElementById('route-modal');
            if (modalElement) { 
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        closeRouteModal();
                    }
                });
            }

            // 2. Load Theme (Local Storage)
            const defaultTheme = 'dark';
            const savedTheme = localStorage.getItem('pu-theme') || defaultTheme;
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.add('light');
            }

            if (document.getElementById('theme-toggle')) {
                 document.getElementById('theme-toggle').value = savedTheme;
            }
            
            // 3. Render Dynamic Content
            renderMarquee(); 
            renderHomeContent(); 
            
            // 4. Initialize Auth and Start App Flow
            if (firebaseConfig) {
                 initializeAuth(); // Starts Firebase Auth/Listener
            } else {
                 // Fallback to purely local storage if Firebase config is missing
                 checkAuth();
            }
        });
    </script>
</body>
</html>
